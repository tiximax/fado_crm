# Tests for payment service idempotency from datetime import datetime from sqlalchemy.orm import Session from services.payment_service import create_transaction, set_txn_gateway_ref, update_status_by_ref from models import PaymentStatus def test_update_status_idempotent_no_downgrade(db_session: Session): # create a transaction and set gateway ref txn = create_transaction(db_session, order_id=1, amount=100000, method="vnpay") set_txn_gateway_ref(db_session, txn.transaction_id, "REF123") # First set to SUCCESS updated = update_status_by_ref(db_session, "REF123", PaymentStatus.SUCCESS) assert updated is not None assert updated.status == PaymentStatus.SUCCESS # Try to downgrade to FAILED - should remain SUCCESS updated2 = update_status_by_ref(db_session, "REF123", PaymentStatus.FAILED) assert updated2 is not None assert updated2.status == PaymentStatus.SUCCESS
